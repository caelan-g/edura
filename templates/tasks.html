{% extends "layouts/layout_user.html" %} {% block body %}
<main class="flex flex-col">
  <div
    class="font-semibold tracking-tight flex flex-row w-full align-middle justify-between mb-2 mt-16 lg:mt-0"
  >
    {% if session['user_type'] == 'student' %}
    <div class="my-auto text-2xl align-middle">My Tasks</div>
    {% else %}
    <div class="my-auto text-2xl align-middle">Assigned Tasks</div>
    {% endif %}
    <button
      onclick="popup('task_popup')"
      class="btn-secondary flex flex-row relative text-md cursor-pointer lg:px-4 px-2"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke-width="3"
        stroke="currentColor"
        class="w-4 h-4 my-auto justify-center lg:mr-2"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M12 4.5v15m7.5-7.5h-15"
        />
      </svg>
      <span class="hidden lg:block">Create Task</span>
    </button>
  </div>
  <div class="lg:flex gap-2 h-full">
    <section class="lg:min-w-[45rem] lg:w-full">
      {% if session['user_type'] == 'teacher' %}

      <div class="h-full w-full">
        <div class="flex flex-col gap-2">
          {% for task in task_data %}
          <div
            class="gap-4 border rounded-md border-gray-200 hover:bg-gray-100 cursor-pointer transition-all lg:shadow-md px-4 py-2 flex flex-row {% if task[8] == 1 %}line-through text-gray-500 bg-gray-100{% endif %}"
            onclick="popup('show_task_popup', {{task[0]}})"
            data-task
            data-task-name="{{task[7]}}"
            data-task-class="{{task[2]}}"
            data-task-created="{{task[4]}}"
            data-task-due-date="{{task[5] or ''}}"
            data-task-status="{% if task[8] == 1 %}completed{% elif task[5] %}{% set due_status = task[5] | dueDateStatus %}{% if due_status %}{{due_status.status}}{% else %}pending{% endif %}{% else %}pending{% endif %}"
            data-task-type="{% if task[10] %}assigned{% else %}personal{% endif %}"
          >
            <container class="flex flex-col w-full">
              <div class="flex flex-row justify-between">
                <div>
                  <div class="flex flex-row text-lg font-semibold">
                    <span
                      class="mr-2 my-auto flex w-4 h-4 rounded-md {{ task[3] | colourDictionary() }}"
                    ></span
                    >{{task[2]}}
                  </div>
                  <div class="text-md">{{task[7]}}</div>
                </div>
                <container class="flex flex-col">
                  <!--TAGS-->
                  <div
                    id="tags"
                    class="hidden lg:flex flex-row gap-2 mt-1 text-nowrap"
                  >
                    {% if task[5] and task[8] != 1 %} {% set due_status =
                    task[5] | dueDateStatus %} {% if due_status %} {% if
                    due_status.status == 'overdue' %}
                    <div
                      class="rounded-md bg-blue-100 font-semibold my-auto px-2 py-1 flex text-xs items-center text-blue-500"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke-width="1.5"
                        stroke="currentColor"
                        class="size-4 my-auto mr-1"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z"
                        />
                      </svg>
                      {{due_status.text}}
                    </div>
                    {% elif due_status.status == 'due_today' or
                    due_status.status == 'due_soon' %}
                    <div
                      class="rounded-md bg-blue-100 font-semibold my-auto px-2 py-1 flex text-xs items-center text-blue-500"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke-width="1.5"
                        stroke="currentColor"
                        class="size-4 my-auto mr-1"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"
                        />
                      </svg>
                      {{due_status.text}}
                    </div>

                    {% endif %} {% endif %} {% endif %} {% if task[11] ==
                    task[10] %}
                    <div
                      class="rounded-md bg-green-100 text-green-600 font-semibold my-auto px-2 py-1 flex text-xs items-center"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke-width="2"
                        stroke="currentColor"
                        class="size-4 my-auto mr-1"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="m4.5 12.75 6 6 9-13.5"
                        />
                      </svg>
                      All Completed
                    </div>
                    {% elif task[11] == 0 %}
                    <div
                      class="rounded-md bg-red-100 text-red-500 font-semibold my-auto px-2 py-1 flex text-xs items-center"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke-width="2"
                        stroke="currentColor"
                        class="size-4 my-auto mr-1"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="M6 18 18 6M6 6l12 12"
                        />
                      </svg>
                      0/{{task[10]}} Completed
                    </div>
                    {% else %}
                    <div
                      class="rounded-md bg-yellow-100 text-yellow-700 font-semibold my-auto px-2 py-1 flex text-xs items-center"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke-width="1.5"
                        stroke="currentColor"
                        class="size-4 my-auto mr-1"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10"
                        />
                      </svg>
                      {{task[11]}} / {{task[10]}} Completed
                    </div>
                    {% endif %}
                  </div>
                  <div
                    class="flex flex-row gap-2 text-right ml-auto mt-2"
                    onclick="event.stopPropagation()"
                  >
                    <svg
                      onclick="popup('edit_task_popup', {{task[0]}})"
                      xmlns="http://www.w3.org/2000/svg"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke-width="1.5"
                      stroke="currentColor"
                      class="size-5 my-auto cursor-pointer"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M12 6.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 12.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 18.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Z"
                      />
                    </svg></div
                ></container>
              </div>
              <!--DATES-->
              <div class="flex text-xs text-gray-500 text-nowrap" id="dates">
                <div class="">Created {{task[4] | dateTimeFormat()}}</div>
                {% if task[5] %}
                <div class="ml-1">â€¢ Due {{task[5] | dateTimeFormat()}}</div>
                {% endif %}
              </div>
              <!--TAGS-->
              <div
                id="tags"
                class="lg:hidden flex flex-row gap-2 mt-1 text-nowrap"
              >
                {% if task[5] and task[8] != 1 %} {% set due_status = task[5] |
                dueDateStatus %} {% if due_status %} {% if due_status.status ==
                'overdue' %}
                <div
                  class="rounded-md bg-blue-100 font-semibold my-auto px-2 py-1 flex text-xs items-center text-blue-500"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="1.5"
                    stroke="currentColor"
                    class="size-4 my-auto mr-1"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z"
                    />
                  </svg>
                  {{due_status.text}}
                </div>
                {% elif due_status.status == 'due_today' or due_status.status ==
                'due_soon' %}
                <div
                  class="rounded-md bg-blue-100 font-semibold my-auto px-2 py-1 flex text-xs items-center text-blue-500"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="1.5"
                    stroke="currentColor"
                    class="size-4 my-auto mr-1"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"
                    />
                  </svg>
                  {{due_status.text}}
                </div>

                {% endif %} {% endif %} {% endif %} {% if task[11] == task[10]
                %}
                <div
                  class="rounded-md bg-green-100 text-green-600 font-semibold my-auto px-2 py-1 flex text-xs items-center"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="2"
                    stroke="currentColor"
                    class="size-4 my-auto mr-1"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="m4.5 12.75 6 6 9-13.5"
                    />
                  </svg>
                  All Completed
                </div>
                {% elif task[11] == 0 %}
                <div
                  class="rounded-md bg-red-100 text-red-500 font-semibold my-auto px-2 py-1 flex text-xs items-center"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="2"
                    stroke="currentColor"
                    class="size-4 my-auto mr-1"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M6 18 18 6M6 6l12 12"
                    />
                  </svg>
                  0/{{task[10]}} Completed
                </div>
                {% else %}
                <div
                  class="rounded-md bg-yellow-100 text-yellow-700 font-semibold my-auto px-2 py-1 flex text-xs items-center"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="1.5"
                    stroke="currentColor"
                    class="size-4 my-auto mr-1"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10"
                    />
                  </svg>
                  {{task[11]}} / {{task[10]}} Completed
                </div>
                {% endif %}
              </div>
            </container>
          </div>
          {% endfor %}
        </div>
      </div>
      <div id="task_popup" class="popup" onclick="popup('task_popup')">
        <div
          class="popup-content w-[25rem] lg:w-[30rem]"
          onclick="event.stopPropagation()"
        >
          <form action="/create_task" method="post" class="flex flex-col gap-4">
            <div>
              <div class="text-2xl font-semibold tracking-tight">
                Create new task
              </div>
              <div class="text-sm text-gray-600 font-normal tracking-tight">
                Set up a task to complete
              </div>
            </div>
            <div class="flex flex-col">
              <label for="class_id" class="text-xs font-semibold"
                >Task Name</label
              >
              <input
                autocomplete="off"
                name="task_description"
                placeholder="e.g. Math Chapter 15A"
                type="text"
                required
              />
            </div>

            <div class="flex flex-col">
              <label for="class_id" class="text-xs font-semibold">Class</label>
              <select
                name="class_id"
                id="class_id"
                required
                class="block w-full border border-gray-300 rounded-md px-1 py-2 text-sm bg-white focus:outline-none focus:ring-1 focus:ring-neutral-400 focus:border-neutral-400"
              >
                <option value="" disabled selected>Select a class</option>
                {% for class in class_data %}

                <option value="{{ class[0] }}">{{ class[1] }}</option>
                {% endfor %}
              </select>
            </div>
            <div>
              <!-- More Options Toggle -->
              <div class="flex flex-col">
                <button
                  type="button"
                  onclick="toggleMoreOptions()"
                  class="flex items-center justify-between w-full text-left text-xs font-semibold text-gray-600 hover:text-gray-800 transition-colors duration-200"
                >
                  <span>More Options</span>
                  <svg
                    id="moreOptionsIcon"
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="2"
                    stroke="currentColor"
                    class="w-4 h-4 transition-transform duration-300"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M19 9l-7 7-7-7"
                    />
                  </svg>
                </button>
              </div>

              <!-- Expandable More Options Section -->
              <div
                id="moreOptionsSection"
                class="overflow-hidden flex flex-col gap-4 transition-all duration-300 ease-in-out max-h-0 opacity-0"
                style="max-height: 0"
              >
                <div class="flex flex-col gap-4 pt-2">
                  <div class="flex flex-col">
                    <label for="duration" class="text-xs font-semibold"
                      >Estimated Time</label
                    >
                    <input
                      autocomplete="off"
                      name="duration"
                      placeholder="e.g. 2 hours"
                      type="text"
                      class="block w-full border border-gray-300 rounded-md px-3 py-2 text-sm bg-white focus:outline-none focus:ring-1 focus:ring-neutral-400 focus:border-neutral-400"
                    />
                  </div>

                  <div class="flex flex-col">
                    <label for="due_date" class="text-xs font-semibold"
                      >Due Date</label
                    >
                    <input
                      autocomplete="off"
                      name="due_date"
                      placeholder="e.g. 2024-12-31"
                      type="date"
                      class="block w-full border border-gray-300 rounded-md px-3 py-2 text-sm bg-white focus:outline-none focus:ring-1 focus:ring-neutral-400 focus:border-neutral-400"
                    />
                  </div>
                </div>
              </div>
            </div>

            <div class="flex flex-row gap-2 mt-4">
              <div class="btn-tertiary w-1/2" onclick="popup('task_popup')">
                Cancel
              </div>
              <button type="submit" class="btn-secondary w-1/2 text-center">
                Create Task
              </button>
            </div>
          </form>
        </div>
      </div>
      {% for task in task_data %}
      <div
        id="task_id_{{task[0]}}"
        class="popup"
        onclick="popup('edit_task_popup', {{task[0]}})"
      >
        <div
          class="popup-content w-[25rem] lg:w-[30rem]"
          onclick="event.stopPropagation()"
        >
          <form action="/edit_task" method="post" class="flex flex-col gap-4">
            <input type="hidden" name="task_id" value="{{task[0]}}" />
            <div>
              <div class="text-2xl font-semibold tracking-tight">Edit task</div>
              <div class="text-sm text-gray-600 font-normal tracking-tight">
                Make changes to a task
              </div>
            </div>
            <div class="flex flex-col">
              <label
                for="task_description_{{task[0]}}"
                class="text-xs font-semibold"
                >Task Name</label
              >
              <input
                autocomplete="off"
                name="task_description"
                id="task_description_{{task[0]}}"
                value="{{task[7]}}"
                placeholder="e.g. Math Chapter 15A"
                type="text"
                required
              />
            </div>

            <div class="flex flex-col">
              <label for="class_id_{{task[0]}}" class="text-xs font-semibold"
                >Class</label
              >
              <select
                name="class_id"
                id="class_id_{{task[0]}}"
                required
                class="block w-full border border-gray-300 rounded-md px-1 py-2 text-sm bg-white focus:outline-none focus:ring-1 focus:ring-neutral-400 focus:border-neutral-400"
              >
                {% for class in class_data %} {% if class[0] == task[1] %}
                <option value="{{ class[0] }}" selected>{{ class[1] }}</option>
                {% else %}
                <option value="{{ class[0] }}">{{ class[1] }}</option>
                {% endif %} {% endfor %}
              </select>
            </div>

            <div class="flex flex-col gap-4 pt-2">
              <div class="flex flex-col">
                <label for="duration_{{task[0]}}" class="text-xs font-semibold"
                  >Estimated Time (optional)</label
                >
                <input
                  autocomplete="off"
                  name="duration"
                  id="duration_{{task[0]}}"
                  placeholder="e.g. 2 hours"
                  type="text"
                  value="{{task[6] or ''}}"
                  class="block w-full border border-gray-300 rounded-md px-3 py-2 text-sm bg-white focus:outline-none focus:ring-1 focus:ring-neutral-400 focus:border-neutral-400"
                />
              </div>

              <div class="flex flex-col">
                <label for="due_date_{{task[0]}}" class="text-xs font-semibold"
                  >Due Date (optional)</label
                >
                <input
                  autocomplete="off"
                  name="due_date"
                  id="due_date_{{task[0]}}"
                  placeholder="e.g. 2024-12-31"
                  type="date"
                  value="{{task[5] or ''}}"
                  class="block w-full border border-gray-300 rounded-md px-3 py-2 text-sm bg-white focus:outline-none focus:ring-1 focus:ring-neutral-400 focus:border-neutral-400"
                />
              </div>
            </div>

            <div class="flex flex-row gap-2 mt-4">
              <a
                href="#"
                class="btn-danger p-2 font-semibold rounded-md cursor-pointer w-1/2 justify-center flex"
                onclick="deleteTask({{task[0]}})"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="1.5"
                  stroke="currentColor"
                  class="size-5 my-auto mr-1"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0"
                  />
                </svg>
                Delete
              </a>
              <button
                type="submit"
                class="btn-secondary w-1/2 justify-center flex"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="1.5"
                  stroke="currentColor"
                  class="size-5 my-auto mr-1"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="m4.5 12.75 6 6 9-13.5"
                  />
                </svg>
                <span class="mr-2">Update Task</span>
              </button>
            </div>
          </form>
        </div>
      </div>
      <div
        id="show_task_id_{{task[0]}}"
        class="popup"
        onclick="popup('show_task_popup', {{task[0]}})"
      >
        <div
          class="popup-content w-[25rem] lg:w-[30rem]"
          onclick="event.stopPropagation()"
        >
          <div class="text-2xl font-semibold">Task Completion</div>
          <div class="w-full grid grid-cols-2 mt-4">
            <div class="font-semibold border-b w-full">Student</div>
            <div class="font-semibold border-b w-full">Status</div>

            {% for student_id in task[8] | getAllStudentIds(task[9]) %} {% set
            status = student_id | getStudentStatus(task[8], task[9]) %}
            <div class="w-full truncate text-nowrap">
              {{student_id | getStudentName}}
            </div>
            <div class="mr-auto">
              {% if status == 'incomplete' %}
              <div
                class="py-1 px-2 bg-red-100 text-red-500 rounded-md text-xs my-0.5 font-semibold"
              >
                Incomplete
              </div>
              {% else %}
              <div
                class="py-1 px-2 bg-green-100 text-green-600 rounded-md text-xs my-0.5 font-semibold"
              >
                Complete
              </div>
              {% endif %}
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
      {% endfor %} {% else %}
      <div class="h-full w-full">
        <div class="flex flex-col gap-2">
          {% for task in task_data %}
          <div
            class="gap-4 border rounded-md border-gray-200 lg:shadow-md px-4 py-2 flex flex-row {% if task[8] == 1 %}line-through text-gray-500 bg-gray-100{% endif %}"
            data-task
            data-task-name="{{task[7]}}"
            data-task-class="{{task[2]}}"
            data-task-created="{{task[4]}}"
            data-task-due-date="{{task[5] or ''}}"
            data-task-status="{% if task[8] == 1 %}completed{% elif task[5] %}{% set due_status = task[5] | dueDateStatus %}{% if due_status %}{{due_status.status}}{% else %}pending{% endif %}{% else %}pending{% endif %}"
            data-task-type="{% if task[10] %}assigned{% else %}personal{% endif %}"
          >
            {% if task[8] == 1 %}
            <!-- Task is completed -->
            <input
              type="checkbox"
              checked
              class="my-auto w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 border-2 rounded focus:ring-blue-500 focus:ring-2 cursor-pointer"
              onchange="completeTask({{task[0]}})"
            />
            {% else %}
            <!-- Task is not completed -->
            <input
              type="checkbox"
              class="my-auto w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 border-2 rounded focus:ring-blue-500 focus:ring-2 cursor-pointer"
              onchange="completeTask({{task[0]}})"
            />
            {% endif %}
            <container class="flex flex-col w-full">
              <div class="flex flex-row justify-between">
                <div>
                  <div class="text-lg font-semibold">{{task[7]}}</div>
                  <div class="flex flex-row">
                    <span
                      class="mr-2 my-auto flex w-4 h-4 rounded-md {{ task[3] | colourDictionary() }}"
                    ></span
                    >{{task[2]}}
                  </div>
                </div>
                <container class="flex flex-col">
                  <!--TAGS-->
                  <div
                    id="tags"
                    class="hidden lg:flex flex-row gap-2 mt-1 text-nowrap"
                  >
                    {% if task[10] %}
                    <div
                      class="rounded-md bg-blue-100 text-blue-500 font-semibold my-auto px-2 py-1 flex text-xs items-center"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke-width="1.5"
                        stroke="currentColor"
                        class="size-4 my-auto mr-1"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10"
                        />
                      </svg>
                      Assigned
                    </div>
                    {% else %}
                    <div
                      class="rounded-md bg-green-100 text-green-600 font-semibold my-auto px-2 py-1 flex text-xs items-center"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke-width="1.5"
                        stroke="currentColor"
                        class="size-4 my-auto mr-1"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="M17.982 18.725A7.488 7.488 0 0 0 12 15.75a7.488 7.488 0 0 0-5.982 2.975m11.963 0a9 9 0 1 0-11.963 0m11.963 0A8.966 8.966 0 0 1 12 21a8.966 8.966 0 0 1-5.982-2.275M15 9.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"
                        />
                      </svg>

                      Personal
                    </div>
                    {% endif %} {% if task[5] and task[8] != 1 %} {% set
                    due_status = task[5] | dueDateStatus %} {% if due_status %}
                    {% if due_status.status == 'overdue' %}
                    <div
                      class="rounded-md bg-red-100 font-semibold my-auto px-2 py-1 flex text-xs items-center text-red-600"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke-width="1.5"
                        stroke="currentColor"
                        class="size-4 my-auto mr-1"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z"
                        />
                      </svg>
                      {{due_status.text}}
                    </div>
                    {% elif due_status.status == 'due_today' %}
                    <div
                      class="rounded-md bg-yellow-100 font-semibold my-auto px-2 py-1 flex text-xs items-center text-yellow-700"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke-width="1.5"
                        stroke="currentColor"
                        class="size-4 my-auto mr-1"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"
                        />
                      </svg>
                      {{due_status.text}}
                    </div>
                    {% elif due_status.status == 'due_soon' %}
                    <div
                      class="rounded-md bg-yellow-100 text-yellow-700 font-semibold my-auto px-2 py-1 flex text-xs items-center"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke-width="1.5"
                        stroke="currentColor"
                        class="size-4 my-auto mr-1"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"
                        />
                      </svg>
                      {{due_status.text}}
                    </div>
                    {% endif %} {% endif %} {% endif %}
                  </div>
                  <div class="flex flex-row gap-2 text-right ml-auto mt-2">
                    <svg
                      onclick="popup('edit_task_popup', {{task[0]}})"
                      xmlns="http://www.w3.org/2000/svg"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke-width="1.5"
                      stroke="currentColor"
                      class="size-5 my-auto cursor-pointer"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M12 6.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 12.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 18.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Z"
                      />
                    </svg></div
                ></container>
              </div>
              <!--DATES-->
              <div class="flex text-xs text-gray-500 text-nowrap" id="dates">
                <div class="">Created {{task[4] | dateTimeFormat()}}</div>
                {% if task[5] %}
                <div class="ml-1">â€¢ Due {{task[5] | dateTimeFormat()}}</div>
                {% endif %}
              </div>
              <!--TAGS-->
              <div
                id="tags"
                class="lg:hidden flex flex-row gap-2 mt-1 text-nowrap"
              >
                {% if task[10] %}
                <div
                  class="rounded-md bg-blue-100 text-blue-500 font-semibold my-auto px-2 py-1 flex text-xs items-center"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="1.5"
                    stroke="currentColor"
                    class="size-4 my-auto mr-1"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10"
                    />
                  </svg>
                  Assigned
                </div>
                {% else %}
                <div
                  class="rounded-md bg-green-100 text-green-600 font-semibold my-auto px-2 py-1 flex text-xs items-center"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="1.5"
                    stroke="currentColor"
                    class="size-4 my-auto mr-1"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M17.982 18.725A7.488 7.488 0 0 0 12 15.75a7.488 7.488 0 0 0-5.982 2.975m11.963 0a9 9 0 1 0-11.963 0m11.963 0A8.966 8.966 0 0 1 12 21a8.966 8.966 0 0 1-5.982-2.275M15 9.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"
                    />
                  </svg>

                  Personal
                </div>
                {% endif %} {% if task[5] and task[8] != 1 %} {% set due_status
                = task[5] | dueDateStatus %} {% if due_status %} {% if
                due_status.status == 'overdue' %}
                <div
                  class="rounded-md bg-red-100 font-semibold my-auto px-2 py-1 flex text-xs items-center text-red-600"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="1.5"
                    stroke="currentColor"
                    class="size-4 my-auto mr-1"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z"
                    />
                  </svg>
                  {{due_status.text}}
                </div>
                {% elif due_status.status == 'due_today' %}
                <div
                  class="rounded-md bg-yellow-100 font-semibold my-auto px-2 py-1 flex text-xs items-center text-yellow-700"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="1.5"
                    stroke="currentColor"
                    class="size-4 my-auto mr-1"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"
                    />
                  </svg>
                  {{due_status.text}}
                </div>
                {% elif due_status.status == 'due_soon' %}
                <div
                  class="rounded-md bg-yellow-100 text-yellow-700 font-semibold my-auto px-2 py-1 flex text-xs items-center"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="1.5"
                    stroke="currentColor"
                    class="size-4 my-auto mr-1"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"
                    />
                  </svg>
                  {{due_status.text}}
                </div>
                {% endif %} {% endif %} {% endif %}
              </div>
            </container>
          </div>
          {% endfor %}
        </div>
      </div>
      <div id="task_popup" class="popup" onclick="popup('task_popup')">
        <div
          class="popup-content w-[25rem] lg:w-[30rem]"
          onclick="event.stopPropagation()"
        >
          <form action="/create_task" method="post" class="flex flex-col gap-4">
            <div>
              <div class="text-2xl font-semibold tracking-tight">
                Create new task
              </div>
              <div class="text-sm text-gray-600 font-normal tracking-tight">
                Set up a task to complete
              </div>
            </div>
            <div class="flex flex-col">
              <label for="class_id" class="text-xs font-semibold"
                >Task Name</label
              >
              <input
                autocomplete="off"
                name="task_description"
                placeholder="e.g. Math Chapter 15A"
                type="text"
                required
              />
            </div>

            <div class="flex flex-col">
              <label for="class_id" class="text-xs font-semibold">Class</label>
              <select
                name="class_id"
                id="class_id"
                required
                class="block w-full border border-gray-300 rounded-md px-1 py-2 text-sm bg-white focus:outline-none focus:ring-1 focus:ring-neutral-400 focus:border-neutral-400"
              >
                <option value="" disabled selected>Select a class</option>
                {% for class in class_data %}

                <option value="{{ class[0] }}">{{ class[1] }}</option>
                {% endfor %}
              </select>
            </div>
            <div>
              <!-- More Options Toggle -->
              <div class="flex flex-col">
                <button
                  type="button"
                  onclick="toggleMoreOptions()"
                  class="flex items-center justify-between w-full text-left text-xs font-semibold text-gray-600 hover:text-gray-800 transition-colors duration-200"
                >
                  <span>More Options</span>
                  <svg
                    id="moreOptionsIcon"
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="2"
                    stroke="currentColor"
                    class="w-4 h-4 transition-transform duration-300"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M19 9l-7 7-7-7"
                    />
                  </svg>
                </button>
              </div>

              <!-- Expandable More Options Section -->
              <div
                id="moreOptionsSection"
                class="overflow-hidden flex flex-col gap-4 transition-all duration-300 ease-in-out max-h-0 opacity-0"
                style="max-height: 0"
              >
                <div class="flex flex-col gap-4 pt-2">
                  <div class="flex flex-col">
                    <label for="duration" class="text-xs font-semibold"
                      >Estimated Time</label
                    >
                    <input
                      autocomplete="off"
                      name="duration"
                      placeholder="e.g. 2 hours"
                      type="text"
                      class="block w-full border border-gray-300 rounded-md px-3 py-2 text-sm bg-white focus:outline-none focus:ring-1 focus:ring-neutral-400 focus:border-neutral-400"
                    />
                  </div>

                  <div class="flex flex-col">
                    <label for="due_date" class="text-xs font-semibold"
                      >Due Date</label
                    >
                    <input
                      autocomplete="off"
                      name="due_date"
                      placeholder="e.g. 2024-12-31"
                      type="date"
                      class="block w-full border border-gray-300 rounded-md px-3 py-2 text-sm bg-white focus:outline-none focus:ring-1 focus:ring-neutral-400 focus:border-neutral-400"
                    />
                  </div>
                </div>
              </div>
            </div>

            <div class="flex flex-row gap-2 mt-4">
              <div class="btn-tertiary w-1/2" onclick="popup('task_popup')">
                Cancel
              </div>
              <button type="submit" class="btn-secondary w-1/2 text-center">
                Create Task
              </button>
            </div>
          </form>
        </div>
      </div>
      {% for task in task_data %}
      <div
        id="task_id_{{task[0]}}"
        class="popup"
        onclick="popup('edit_task_popup', {{task[0]}})"
      >
        <div
          class="popup-content w-[25rem] lg:w-[30rem]"
          onclick="event.stopPropagation()"
        >
          <form action="/edit_task" method="post" class="flex flex-col gap-4">
            <input type="hidden" name="task_id" value="{{task[0]}}" />
            <div>
              <div class="text-2xl font-semibold tracking-tight">Edit task</div>
              <div class="text-sm text-gray-600 font-normal tracking-tight">
                Make changes to a task
              </div>
            </div>
            <div class="flex flex-col">
              <label
                for="task_description_{{task[0]}}"
                class="text-xs font-semibold"
                >Task Name</label
              >
              <input
                autocomplete="off"
                name="task_description"
                id="task_description_{{task[0]}}"
                value="{{task[7]}}"
                placeholder="e.g. Math Chapter 15A"
                type="text"
                required
              />
            </div>

            <div class="flex flex-col">
              <label for="class_id_{{task[0]}}" class="text-xs font-semibold"
                >Class</label
              >
              <select
                name="class_id"
                id="class_id_{{task[0]}}"
                required
                class="block w-full border border-gray-300 rounded-md px-1 py-2 text-sm bg-white focus:outline-none focus:ring-1 focus:ring-neutral-400 focus:border-neutral-400"
              >
                {% for class in class_data %} {% if class[0] == task[1] %}
                <option value="{{ class[0] }}" selected>{{ class[1] }}</option>
                {% else %}
                <option value="{{ class[0] }}">{{ class[1] }}</option>
                {% endif %} {% endfor %}
              </select>
            </div>

            <div class="flex flex-col gap-4 pt-2">
              <div class="flex flex-col">
                <label for="duration_{{task[0]}}" class="text-xs font-semibold"
                  >Estimated Time (optional)</label
                >
                <input
                  autocomplete="off"
                  name="duration"
                  id="duration_{{task[0]}}"
                  placeholder="e.g. 2 hours"
                  type="text"
                  value="{{task[6] or ''}}"
                  class="block w-full border border-gray-300 rounded-md px-3 py-2 text-sm bg-white focus:outline-none focus:ring-1 focus:ring-neutral-400 focus:border-neutral-400"
                />
              </div>

              <div class="flex flex-col">
                <label for="due_date_{{task[0]}}" class="text-xs font-semibold"
                  >Due Date (optional)</label
                >
                <input
                  autocomplete="off"
                  name="due_date"
                  id="due_date_{{task[0]}}"
                  placeholder="e.g. 2024-12-31"
                  type="date"
                  value="{{task[5] or ''}}"
                  class="block w-full border border-gray-300 rounded-md px-3 py-2 text-sm bg-white focus:outline-none focus:ring-1 focus:ring-neutral-400 focus:border-neutral-400"
                />
              </div>
            </div>

            <div class="flex flex-row gap-2 mt-4">
              <a
                href="#"
                class="btn-danger p-2 font-semibold rounded-md cursor-pointer w-1/2 justify-center flex"
                onclick="deleteTask({{task[0]}})"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="1.5"
                  stroke="currentColor"
                  class="size-5 my-auto mr-1"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0"
                  />
                </svg>
                Delete
              </a>
              <button
                type="submit"
                class="btn-secondary w-1/2 justify-center flex"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="1.5"
                  stroke="currentColor"
                  class="size-5 my-auto mr-1"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="m4.5 12.75 6 6 9-13.5"
                  />
                </svg>
                <span class="mr-2">Update Task</span>
              </button>
            </div>
          </form>
        </div>
      </div>
      {% endfor %} {% endif %}
    </section>
    <section class="hidden lg:block w-full sticky top-12 h-full">
      <div
        class="w-full rounded-md border-gray-200 border lg:shadow-md bg-white max-w-[30rem]"
      >
        <div class="flex items-center justify-between px-4 pt-4">
          <div>
            <div class="text-2xl font-semibold">Filters</div>
            <div class="text-sm text-gray-600">Organise your tasks</div>
          </div>
          <div id="activeFiltersIndicator" class="hidden">
            <span
              class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-500"
            >
              <span id="activeFiltersCount">0</span>active
            </span>
          </div>
        </div>

        <div class="space-y-2 overflow-y-auto h-full mt-4 px-4 pb-4">
          <!-- Search Filter -->
          <div>
            <button
              type="button"
              onclick="toggleFilterSection('searchSection')"
              class="flex items-center justify-between w-full text-left text-xs font-semibold text-gray-700 hover:text-gray-900 transition-colors duration-200 mb-2"
            >
              <span>Search</span>
              <svg
                id="searchSectionIcon"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke-width="2"
                stroke="currentColor"
                class="w-4 h-4 transition-transform duration-300 -rotate-90"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M15.75 19.5 8.25 12l7.5-7.5"
                />
              </svg>
            </button>
            <div
              id="searchSection"
              class="overflow-hidden transition-all duration-300 ease-in-out"
            >
              <input
                id="searchInput"
                type="text"
                placeholder="Search by task name..."
                class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-gray-500 focus:border-gray-500"
                onkeyup="filterTasks()"
              />
            </div>
          </div>

          <!-- Sort Options -->
          <div>
            <button
              type="button"
              onclick="toggleFilterSection('sortSection')"
              class="flex items-center justify-between w-full text-left text-xs font-semibold text-gray-700 hover:text-gray-900 transition-colors duration-200 mb-2"
            >
              <span>Sort By</span>
              <svg
                id="sortSectionIcon"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke-width="2"
                stroke="currentColor"
                class="w-4 h-4 transition-transform duration-300 -rotate-90"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M15.75 19.5 8.25 12l7.5-7.5"
                />
              </svg>
            </button>
            <div
              id="sortSection"
              class="overflow-hidden transition-all duration-300 ease-in-out"
            >
              <select
                id="sortBy"
                onchange="filterTasks()"
                class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-gray-500 focus:border-gray-500"
              >
                <option value="created-desc">Created Date (Newest)</option>
                <option value="created-asc">Created Date (Oldest)</option>
                <option value="due-asc">Due Date (Closest)</option>
                <option value="due-desc">Due Date (Furthest)</option>
                <option value="name-asc">Task Name (A-Z)</option>
                <option value="name-desc">Task Name (Z-A)</option>
                <option value="class-asc">Class Name (A-Z)</option>
              </select>
            </div>
          </div>

          <!-- Status Filter -->
          <div>
            <button
              type="button"
              onclick="toggleFilterSection('statusSection')"
              class="flex items-center justify-between w-full text-left text-xs font-semibold text-gray-700 hover:text-gray-900 transition-colors duration-200 mb-2"
            >
              <span>Status</span>
              <svg
                id="statusSectionIcon"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke-width="2"
                stroke="currentColor"
                class="w-4 h-4 transition-transform duration-300"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M15.75 19.5 8.25 12l7.5-7.5"
                />
              </svg>
            </button>
            <div
              id="statusSection"
              class="overflow-hidden transition-all duration-300 ease-in-out"
              style="max-height: 0px"
            >
              <div class="space-y-2">
                {% if session['user_type'] == 'student' %}
                <label class="flex items-center">
                  <input
                    type="checkbox"
                    name="statusFilter"
                    value="completed"
                    onchange="filterTasks()"
                    class="mr-2 w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2"
                  />
                  <span class="text-sm">Completed</span>
                </label>
                {% endif %}
                <label class="flex items-center">
                  <input
                    type="checkbox"
                    name="statusFilter"
                    value="overdue"
                    onchange="filterTasks()"
                    class="mr-2 w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2"
                  />
                  <span class="text-sm"
                    >{% if session['user_type'] == 'student' %} Overdue {% else
                    %} Past Due {% endif %}</span
                  >
                </label>
                <label class="flex items-center">
                  <input
                    type="checkbox"
                    name="statusFilter"
                    value="pending"
                    onchange="filterTasks()"
                    class="mr-2 w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2"
                  />
                  <span class="text-sm">No Due Date</span>
                </label>
                <label class="flex items-center">
                  <input
                    type="checkbox"
                    name="statusFilter"
                    value="due_today"
                    onchange="filterTasks()"
                    class="mr-2 w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2"
                  />
                  <span class="text-sm">Due Today</span>
                </label>
                <label class="flex items-center">
                  <input
                    type="checkbox"
                    name="statusFilter"
                    value="due_soon"
                    onchange="filterTasks()"
                    class="mr-2 w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2"
                  />
                  <span class="text-sm">Due Soon</span>
                </label>
              </div>
            </div>
          </div>

          <!-- Class Filter -->
          <div>
            <button
              type="button"
              onclick="toggleFilterSection('classSection')"
              class="flex items-center justify-between w-full text-left text-xs font-semibold text-gray-700 hover:text-gray-900 transition-colors duration-200 mb-2"
            >
              <span>Class</span>
              <svg
                id="classSectionIcon"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke-width="2"
                stroke="currentColor"
                class="w-4 h-4 transition-transform duration-300"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M15.75 19.5 8.25 12l7.5-7.5"
                />
              </svg>
            </button>
            <div
              id="classSection"
              class="overflow-hidden transition-all duration-300 ease-in-out"
              style="max-height: 0px"
            >
              <select
                id="classFilter"
                onchange="filterTasks()"
                class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-gray-500 focus:border-gray-500"
              >
                <option value="all">All Classes</option>
                {% for class in class_data %}
                <option value="{{ class[1] }}">{{ class[1] }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          {% if session['user_type'] == 'student' %}
          <!-- Task Type Filter -->
          <div>
            <button
              type="button"
              onclick="toggleFilterSection('typeSection')"
              class="flex items-center justify-between w-full text-left text-xs font-semibold text-gray-700 hover:text-gray-900 transition-colors duration-200 mb-2"
            >
              <span>Task Type</span>
              <svg
                id="typeSectionIcon"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke-width="2"
                stroke="currentColor"
                class="w-4 h-4 transition-transform duration-300"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M15.75 19.5 8.25 12l7.5-7.5"
                />
              </svg>
            </button>
            <div
              id="typeSection"
              class="overflow-hidden transition-all duration-300 ease-in-out"
              style="max-height: 0px"
            >
              <div class="space-y-2">
                <label class="flex items-center">
                  <input
                    type="checkbox"
                    name="typeFilter"
                    value="assigned"
                    onchange="filterTasks()"
                    class="mr-2 w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2"
                  />
                  <span class="text-sm">Assigned</span>
                </label>
                <label class="flex items-center">
                  <input
                    type="checkbox"
                    name="typeFilter"
                    value="personal"
                    onchange="filterTasks()"
                    class="mr-2 w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2"
                  />
                  <span class="text-sm">Personal</span>
                </label>
              </div>
            </div>
          </div>
          {% endif %}

          <!-- Due Date Filter -->
          <div>
            <button
              type="button"
              onclick="toggleFilterSection('dueDateSection')"
              class="flex items-center justify-between w-full text-left text-xs font-semibold text-gray-700 hover:text-gray-900 transition-colors duration-200 mb-2"
            >
              <span>Due Date Range</span>
              <svg
                id="dueDateSectionIcon"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke-width="2"
                stroke="currentColor"
                class="w-4 h-4 transition-transform duration-300"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M15.75 19.5 8.25 12l7.5-7.5"
                />
              </svg>
            </button>
            <div
              id="dueDateSection"
              class="overflow-hidden transition-all duration-300 ease-in-out"
              style="max-height: 0px"
            >
              <div class="space-y-2">
                <input
                  id="dueDateFrom"
                  type="date"
                  onchange="filterTasks()"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-gray-500 focus:border-gray-500"
                  placeholder="From"
                />
                <input
                  id="dueDateTo"
                  type="date"
                  onchange="filterTasks()"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-gray-500 focus:border-gray-500"
                  placeholder="To"
                />
              </div>
            </div>
          </div>

          <!-- Clear Filters -->
          <div class="pt-4 border-t border-gray-200">
            <button
              onclick="clearFilters()"
              class="w-full px-4 py-2 text-sm font-semibold rounded-md btn-secondary transition-colors"
            >
              Clear All Filters
            </button>
          </div>

          <!-- Task Count -->
          <div class="text-xs text-gray-500 text-center">
            <span id="taskCount">{{ task_data|length }}</span> tasks found
          </div>
        </div>
      </div>
    </section>
  </div>
  <div class="text-sm text-gray-500 mx-auto mt-12 text-center w-full">
    Completed tasks are archived after 3 days of inactivity. <br />
    <a
      href="#"
      class="text-sm text-gray-500 underline mx-auto mb-4 text-center w-full"
      >View archived tasks</a
    >
  </div>
</main>
<script>
  function popup(popup_id, task_id) {
    let popup;
    if (popup_id == "edit_task_popup") {
      popup = document.getElementById(`task_id_${task_id}`);
    } else if (popup_id == "show_task_popup") {
      popup = document.getElementById(`show_task_id_${task_id}`);
    } else {
      popup = document.getElementById(popup_id);
    }

    if (popup.classList.contains("active")) {
      popup.classList.remove("active");
      if (popup_id == "edit_task_popup") {
        toggleClassLink(false);
      }
    } else {
      popup.classList.add("active");
      if (popup_id == "edit_task_popup") {
        toggleClassLink(true);
      }
    }

    function toggleClassLink(popup) {
      const a = document.querySelectorAll(".task_link");
      a.forEach((el) => {
        let originalUrl = el.getAttribute("data-original-url");
        if (popup) {
          el.setAttribute("href", "#");
        } else {
          el.setAttribute("href", originalUrl);
        }
      });
    }
  }

  function toggleMoreOptions() {
    const section = document.getElementById("moreOptionsSection");
    const icon = document.getElementById("moreOptionsIcon");

    if (section.style.maxHeight === "0px" || section.style.maxHeight === "") {
      // Expand
      section.style.maxHeight = section.scrollHeight + "px";
      section.classList.remove("opacity-0");
      section.classList.add("opacity-100");
      icon.style.transform = "rotate(-90deg)";
    } else {
      // Collapse
      section.style.maxHeight = "0px";
      section.classList.remove("opacity-100");
      section.classList.add("opacity-0");
      icon.style.transform = "rotate(0deg)";
    }
  }
  function deleteTask(task_id) {
    const formData = new FormData();
    formData.append("task_id", task_id);

    fetch("/delete_task", {
      method: "POST",
      body: formData,
    })
      .then((response) => {
        if (response.ok) {
          location.reload();
        } else {
          console.error("Failed to delete task");
        }
      })
      .catch((error) => {
        console.error("Error:", error);
      });
  }

  function completeTask(task_id) {
    const formData = new FormData();
    formData.append("task_id", task_id);

    fetch("/complete_task", {
      method: "POST",
      body: formData,
    })
      .then((response) => {
        if (response.ok) {
          location.reload();
        } else {
          console.error("Failed to complete task");
        }
      })
      .catch((error) => {
        console.error("Error:", error);
      });
  }

  // Filter and search functionality
  function filterTasks() {
    const searchTerm = document
      .getElementById("searchInput")
      .value.toLowerCase();

    // Get selected status filters (checkboxes)
    const statusCheckboxes = document.querySelectorAll(
      'input[name="statusFilter"]:checked'
    );
    const selectedStatuses = Array.from(statusCheckboxes).map((cb) => cb.value);

    // Get selected type filters (checkboxes)
    const typeCheckboxes = document.querySelectorAll(
      'input[name="typeFilter"]:checked'
    );
    const selectedTypes = Array.from(typeCheckboxes).map((cb) => cb.value);

    const classFilter = document.getElementById("classFilter").value;
    const dueDateFrom = document.getElementById("dueDateFrom").value;
    const dueDateTo = document.getElementById("dueDateTo").value;
    const sortBy = document.getElementById("sortBy").value;

    // Count active filters
    let activeFilters = 0;
    if (searchTerm) activeFilters++;
    if (selectedStatuses.length > 0) activeFilters++;
    if (classFilter !== "all") activeFilters++;
    if (selectedTypes.length > 0) activeFilters++;
    if (dueDateFrom || dueDateTo) activeFilters++;
    if (sortBy !== "created-desc") activeFilters++;

    // Update active filters indicator
    const indicator = document.getElementById("activeFiltersIndicator");
    const count = document.getElementById("activeFiltersCount");
    if (activeFilters > 0) {
      indicator.classList.remove("hidden");
      count.textContent = activeFilters;
    } else {
      indicator.classList.add("hidden");
    }

    // Get all task elements
    const taskElements = document.querySelectorAll("[data-task]");
    let visibleCount = 0;

    // Convert to array for sorting
    let tasksArray = Array.from(taskElements);

    // Filter tasks
    tasksArray.forEach((task) => {
      let show = true;

      // Search filter
      if (searchTerm) {
        const taskName = task.getAttribute("data-task-name").toLowerCase();
        if (!taskName.includes(searchTerm)) {
          show = false;
        }
      }

      // Status filter (multiple selection)
      if (selectedStatuses.length > 0) {
        const taskStatus = task.getAttribute("data-task-status");
        if (!selectedStatuses.includes(taskStatus)) {
          show = false;
        }
      }

      // Class filter
      if (classFilter !== "all") {
        const taskClass = task.getAttribute("data-task-class");
        if (taskClass !== classFilter) {
          show = false;
        }
      }

      // Type filter (multiple selection, for students)
      if (selectedTypes.length > 0) {
        const taskType = task.getAttribute("data-task-type");
        if (!selectedTypes.includes(taskType)) {
          show = false;
        }
      }

      // Due date range filter
      if (dueDateFrom || dueDateTo) {
        const taskDueDate = task.getAttribute("data-task-due-date");
        if (taskDueDate) {
          const dueDate = new Date(taskDueDate);
          if (dueDateFrom && dueDate < new Date(dueDateFrom)) {
            show = false;
          }
          if (dueDateTo && dueDate > new Date(dueDateTo)) {
            show = false;
          }
        } else if (dueDateFrom || dueDateTo) {
          // Hide tasks without due dates if date range is specified
          show = false;
        }
      }

      if (show) {
        task.style.display = "";
        visibleCount++;
      } else {
        task.style.display = "none";
      }
    });

    // Sort visible tasks
    const visibleTasks = tasksArray.filter(
      (task) => task.style.display !== "none"
    );
    sortTasks(visibleTasks, sortBy);

    // Update task count
    document.getElementById("taskCount").textContent = visibleCount;
  }

  function sortTasks(tasks, sortBy) {
    const parent = tasks[0]?.parentNode;
    if (!parent) return;

    tasks.sort((a, b) => {
      // First, prioritize by completion status (uncompleted tasks first)
      const aCompleted = a.getAttribute("data-task-status") === "completed";
      const bCompleted = b.getAttribute("data-task-status") === "completed";

      if (aCompleted !== bCompleted) {
        return aCompleted ? 1 : -1; // Uncompleted tasks (false) come first
      }

      // If both have the same completion status, sort by the selected criteria
      switch (sortBy) {
        case "created-desc":
          return (
            new Date(b.getAttribute("data-task-created")) -
            new Date(a.getAttribute("data-task-created"))
          );
        case "created-asc":
          return (
            new Date(a.getAttribute("data-task-created")) -
            new Date(b.getAttribute("data-task-created"))
          );
        case "due-asc":
          const aDue = a.getAttribute("data-task-due-date");
          const bDue = b.getAttribute("data-task-due-date");
          if (!aDue && !bDue) return 0;
          if (!aDue) return 1;
          if (!bDue) return -1;
          return new Date(aDue) - new Date(bDue);
        case "due-desc":
          const aDueDesc = a.getAttribute("data-task-due-date");
          const bDueDesc = b.getAttribute("data-task-due-date");
          if (!aDueDesc && !bDueDesc) return 0;
          if (!aDueDesc) return 1;
          if (!bDueDesc) return -1;
          return new Date(bDueDesc) - new Date(aDueDesc);
        case "name-asc":
          return a
            .getAttribute("data-task-name")
            .localeCompare(b.getAttribute("data-task-name"));
        case "name-desc":
          return b
            .getAttribute("data-task-name")
            .localeCompare(a.getAttribute("data-task-name"));
        case "class-asc":
          return a
            .getAttribute("data-task-class")
            .localeCompare(b.getAttribute("data-task-class"));
        default:
          return 0;
      }
    });

    // Reorder DOM elements
    tasks.forEach((task) => parent.appendChild(task));
  }

  function clearFilters() {
    // Reset all filter inputs
    document.getElementById("searchInput").value = "";

    // Uncheck all status filter checkboxes
    const statusCheckboxes = document.querySelectorAll(
      'input[name="statusFilter"]'
    );
    statusCheckboxes.forEach((checkbox) => (checkbox.checked = false));

    // Uncheck all type filter checkboxes
    const typeCheckboxes = document.querySelectorAll(
      'input[name="typeFilter"]'
    );
    typeCheckboxes.forEach((checkbox) => (checkbox.checked = false));

    document.getElementById("classFilter").value = "all";
    document.getElementById("dueDateFrom").value = "";
    document.getElementById("dueDateTo").value = "";
    document.getElementById("sortBy").value = "created-desc";

    // Hide active filters indicator
    document.getElementById("activeFiltersIndicator").classList.add("hidden");

    // Re-apply filters (which will show all tasks)
    filterTasks();
  }

  function toggleAllStatus() {
    const statusCheckboxes = document.querySelectorAll(
      'input[name="statusFilter"]'
    );
    const allChecked = Array.from(statusCheckboxes).every((cb) => cb.checked);

    // If all are checked, uncheck all. Otherwise, check all.
    statusCheckboxes.forEach((checkbox) => {
      checkbox.checked = !allChecked;
    });

    filterTasks();
  }

  function toggleAllTypes() {
    const typeCheckboxes = document.querySelectorAll(
      'input[name="typeFilter"]'
    );
    const allChecked = Array.from(typeCheckboxes).every((cb) => cb.checked);

    // If all are checked, uncheck all. Otherwise, check all.
    typeCheckboxes.forEach((checkbox) => {
      checkbox.checked = !allChecked;
    });

    filterTasks();
  }

  function toggleFilterSection(sectionId) {
    const section = document.getElementById(sectionId);
    const icon = document.getElementById(sectionId + "Icon");

    if (section.style.maxHeight === "0px" || section.style.maxHeight === "") {
      // Expand
      section.style.maxHeight = section.scrollHeight + "px";
      icon.style.transform = "rotate(-90deg)";
    } else {
      // Collapse
      section.style.maxHeight = "0px";
      icon.style.transform = "rotate(0deg)";
    }
  }

  // Initialize filters on page load
  document.addEventListener("DOMContentLoaded", function () {
    filterTasks();
  });
</script>
{% endblock %}
